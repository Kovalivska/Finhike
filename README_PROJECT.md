# Finhike Risk Data Analysis - Solution Documentation

## Задача
Анализ XML данных кредитных сделок и расчет метрик на уровне клиентов.

## Структура решения

### Файлы решения:
1. **xml_processor.py** - Python решение для обработки XML файлов
2. **sql_solution.sql** - SQL решение (PostgreSQL/Snowflake)
3. **sample_data/** - Папка с примерами XML файлов для тестирования
4. **README.md** - Данный файл с документацией

## Python Решение

### Требования:
```bash
pip install pandas lxml
```

### Использование:
1. Поместите XML файлы в папку `Data/`
2. Запустите скрипт:
```bash
python xml_processor.py
```

### Выходные файлы:
- `client_metrics_results.csv` - итоговые метрики по клиентам
- `detailed_credit_data.csv` - детальные данные в табличном формате

### Рассчитываемые метрики:
1. **total_loans_count** - общее количество кредитов
2. **closed_loans_ratio** - доля закрытых кредитов от общего количества
3. **expired_30_plus_amount** - сумма просроченных сделок свыше 30 дней

## SQL Решение

### Предварительные условия:
1. Данные должны быть загружены в таблицы `credit_deals` и `deal_history`
2. Структура таблиц описана в начале SQL файла

### Основной запрос:
Выполните основной запрос из файла `sql_solution.sql` для получения метрик по клиентам.

## Логика расчета метрик

### 1. Total count of loans
Подсчитывается количество уникальных сделок (deal_id) для каждого клиента.

### 2. Ratio of closed loans
- Закрытыми считаются сделки, у которых заполнено поле `actual_end_date` (dldff)
- Отношение = количество закрытых сделок / общее количество сделок

### 3. Sum of expired deals amount over 30+ days
- Берутся сделки с `days_overdue` > 30
- Суммируется `overdue_debt` для таких сделок
- Используется последний статус по каждой сделке

## Структура XML данных

### Основные блоки:
- **crdeal** - информация о кредитной сделке
- **deallife** - исторические периоды сделки

### Ключевые поля:
- `dlref` - ID сделки
- `dlamt` - сумма сделки
- `dldff` - фактическая дата закрытия
- `dlamtexp` - сумма просроченной задолженности
- `dldayexp` - количество дней просрочки

## Тестирование

### Запуск с демо-данными:
1. Переименуйте папку `sample_data` в `Data`
2. Запустите `python xml_processor.py`
3. Проверьте результаты в CSV файлах

### Ожидаемые результаты для демо-данных:
- Клиент 001: 2 кредита, 1 закрыт (ratio=0.5), просрочка 30+ дней = 15000
- Клиент 002: 1 кредит, 0 закрыто (ratio=0.0), просрочка 30+ дней = 25000

## Обработка ошибок

Код включает обработку следующих ситуаций:
- Отсутствующие XML файлы
- Поврежденные XML файлы
- Отсутствующие поля в данных
- Некорректные форматы данных

## Масштабируемость

Решение оптимизировано для:
- Обработки больших объемов XML файлов
- Эффективного использования памяти
- Параллельной обработки (при необходимости)

## Контакты

При возникновении вопросов по решению обращайтесь к разработчику.
